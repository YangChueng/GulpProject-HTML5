/**
 *自定义事件监听模块
 */
define(function(require,exports,module){var $=require("zepto"),mEvent={};module.exports=mEvent,mEvent.listen=function(){return{content:$(".m-content"),toolbar:$(".m-toolbar"),effect:$(".m-effect"),preBtn:$(".pre-btn"),delBtn:$(".del-btn"),preview:$(".m-preview"),save:$(".m-save"),back:$(".m-back"),fallback:$("a.pull-left"),_init:function(){this._imageSelect(),this._effectSelect(),this._preview(),this._fallback(),this._fontSelect(),this._save(),this._delete(),this._effectSelect()},_toolBarClick:function(){var $content=$(".m-content"),$container=this.toolbar,$me=this;$container.find("a").off("click").on("click",function(e){$container.find("a").removeClass("active"),$(this).addClass("active");var role=$(this).attr("role");if("group"==role)$(".group-items").show();else{if($(".group-items").hide(),"picture"==role){$content.html(temp);var Photo=require("../image/photo");Photo._init()}else $content.html(sessionStorage[role]);$me._imageSelect(),lazyLoad()}})},_fontSelect:function(){var $container=this.content;$container.find(".m-font").off("click").on("click",function(e){var $font=$(this);if($container.find(".m-font.selected").length>0&&$container.find(".m-font.selected").removeClass("selected").css("border-color","#fff"),!$font.hasClass("selected")){$font.css("border-color","red"),$font.addClass("selected");var font=require("../font/font"),Font=new font;Font.drawFont($font.attr("name"),$font.attr("name"))}})},_imageSelect:function(){var $container=this.content;$container.find("img").off("click").on("click",function(e){e.preventDefault();var $image=$(this),type=$image.attr("type");$image.attr("role");if(!($image.attr("src").indexOf("default")>-1)){$container.find("img.selected").length>0&&$container.find("img.selected").removeClass("selected").css("border-color","#fff"),$image.hasClass("selected")||($image.css("border-color","red"),$image.addClass("selected"));var img=require("../image/image"),Picture=new img;"filter"==type?Picture._operate.filter($image):"svg"==type?Picture.loadSVGImage($image):"photo"==type?Picture.drawImage($image):"frame"==type&&Picture.loadPhotoFrame($image)}})},_effectSelect:function(){var $me=(this.effect.find(".effects a"),this),$content=$(".m-content");$(".m-effect").hide(),$me._toolBarClick(),$me._imageSelect(),$(".m-toolbar").find("a").removeClass("active"),$(".m-toolbar").find('a[role="picture"]').addClass("active"),$content.html(temp),lazyLoad()},_preview:function(){var $preview=this.preview,$me=this;this.preBtn.on("click",function(e){canvas.deactivateAll();var image_str=canvas.toDataURL("png");$preview.show().find(".pre-img img").attr("src",image_str),$me._back()})},_delete:function(){this.delBtn.on("click",function(e){var p=require("../tool/popup"),Popup=new p;Popup.alert("confirm","确定要删除?",function(){0==canvas.getObjects().length&&(null==canvas.overlayImage&&void 0==canvas.overlayImage||canvas.setOverlayImage(null));var canvasObj=canvas.getActiveObject();canvas.remove(canvasObj),canvas.renderAll()})})},_save:function(){this.save.off("click").on("click",function(e){var strData=$(".pre-img").find("img").attr("src"),strDownloadMime="image/octet-stream",_suffix=".png";time=(new Date).getTime();var result=strData.replace("image/png",strDownloadMime);if(!isWX){var a=document.createElement("a");a.download=time+_suffix,a.href=result,a.click()}canvas.clear(),canvas.setOverlayImage(null),canvas.renderAll(),sessionStorage.clear(),$(".m-preview,.m-effect").hide(),$(".m-index").show();var Photo=require("../image/photo");Photo._init()})},_back:function(){var $preview=this.preview;this.back.on("click",function(e){$preview.hide()})},_fallback:function(){var $effect=this.effect,$preview=this.preview;this.fallback.on("click",function(e){var to=$(this).attr("to");"effect"==to?$effect.show():"design"==to&&$preview.hide()})}}}();var lazyLoad=function(){var $=require("jquery");require("lazyload")($);var $content=$(".m-content");$content.on("scroll",function(e){$(".m-content img").lazyload({placeholder:"images/default.gif"})}),$content.find("img").lazyload({placeholder:"images/default.gif"})}});