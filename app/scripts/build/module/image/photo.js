/**
 * 图片相册模块
 * @param  {[type]} require   [description]
 * @param  {[type]} exports   [description]
 * @param  {[type]} module){               var $ [description]
 * @return {[type]}           [description]
 */
define(function(require,exports,module){var $=require("zepto"),mEvent=require("../base/mevent"),Photo={};module.exports=Photo,Photo._init=function(){this.popMobileAlbum()},Photo.popMobileAlbum=function(){this.uploadDirect()},Photo.uploadPhoto=function(){$(".photoInput").off("change").on("change",function(e){console.log("change.."),uploadImage(this,"m-img-list"),this.outerHTML=this.outerHTML})},Photo.uploadDirect=function(){var that=this;$(".photoInput").off("change").on("change",function(e){if(this.files.length>0){var file=this.files[0];console.log(file),$(".preload").show();var fileName=file.name.split(".")[0],suffix=file.name.split(".")[1],key=fileName+(new Date).getTime()+"."+suffix;console.log(key),that.getToken(function(data){that.Qiniu_upload(file,data.uptoken,key)})}else $(".preload").hide(),console&&console.log("form input error")})},Photo.Qiniu_upload=function(f,token,key){var Qiniu_UploadUrl="http://up.qiniu.com",xhr=new XMLHttpRequest;xhr.open("POST",Qiniu_UploadUrl,!0);var formData,startDate;formData=new FormData,null!==key&&void 0!==key&&formData.append("key",key),formData.append("token",token),formData.append("file",f);var taking;xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){var nowDate=(new Date).getTime();taking=nowDate-startDate;var formatSpeed,x=evt.loaded/1024,y=taking/1e3,uploadSpeed=x/y;formatSpeed=uploadSpeed>1024?(uploadSpeed/1024).toFixed(2)+"Mb/s":uploadSpeed.toFixed(2)+"Kb/s";var percentComplete=Math.round(100*evt.loaded/evt.total);console&&console.log(percentComplete,",",formatSpeed)}},!1),xhr.onreadystatechange=function(response){if(4==xhr.readyState&&200==xhr.status&&""!=xhr.responseText){var blkRet=JSON.parse(xhr.responseText);console&&console.log(blkRet),console.log(xhr.responseText);var res=$.parseJSON(xhr.responseText);url="http://7xpgeq.com1.z0.glb.clouddn.com/"+encodeURI(res.key),console.log(url);var img="<img src='"+url+"?imageView2/1/q/30' class='m-source m-image' type='photo'>";temp+=img,$(".m-content").html(temp),$(".preload").hide(),Photo._init(),mEvent.listen._imageSelect()}else 200!=xhr.status&&xhr.responseText&&$(".preload").hide()},startDate=(new Date).getTime(),xhr.send(formData)},Photo.getToken=function(callback){$.ajax({type:"get",url:"http://demo.timepack.cn/qiniu/getToken",dataType:"jsonp",jsonp:"callback",jsonpCallback:"success_jsonpCallback",success:function(json){callback(json)}})},Photo.uploadServer=function(){$.ajax({type:"get",url:"http://demo.timepack.cn/qiniu/getToken",dataType:"jsonp",jsonp:"callback",jsonpCallback:"success_jsonpCallback",success:function(json){console.log(json.uptoken),Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"uploader",flash_swf_url:"",chunk_size:"4mb",uptoken:json.uptoken,domain:"http://qiniu-plupload.qiniudn.com/",flash_swf_url:"./lib/Moxie.swf",unique_names:!0,get_new_uptoken:!1,auto_start:!0,log_level:5,filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}],max_file_size:"10mb"},init:{FilesAdded:function(up,files){},BeforeUpload:function(up,file){},UploadProgress:function(up,file){$(".preload").show()},UploadComplete:function(){},FileUploaded:function(up,file,info){var url="",res=$.parseJSON(info);url="http://7xpgeq.com1.z0.glb.clouddn.com/"+encodeURI(res.key),console.log(url);var img="<img src='"+url+"?imageView2/1/q/30' class='m-source m-image' type='photo'>";temp+=img,$(".m-content").html(temp),$(".preload").hide(),Photo._init(),mEvent.listen._imageSelect()},Error:function(up,err,errTip){-600==err.code&&layer.alert("图片大小超过限制~")}}})},error:function(){alert("请求出错！")}})};var uploadImage=function(fileObj,previewId){$(".preload").show();var allowExtention=".jpg,.bmp,.gif,.png,.jpeg",extention=fileObj.value.substring(fileObj.value.lastIndexOf(".")+1).toLowerCase(),p=(window.navigator.userAgent.toUpperCase(),require("../tool/popup")),Popup=new p;if(!(allowExtention.indexOf(extention)>-1))return $(".preload").hide(),void Popup.alert("","不支持该图片类型!");if(fileObj.files){if(!window.FileReader)return $(".preload").hide(),void Popup.alert("","不支持该图片类型!");var reader=new FileReader;reader.onload=function(e){imageCompress(e.target.result,function(path){setTimeout(function(){showPreviewImage($(fileObj).attr("role"),path),$(".preload").hide()},2e3)})};try{reader.readAsDataURL(fileObj.files[0])}catch(e){return console.log(e),void $.hidePreloader()}}},showPreviewImage=function(role,img){var img="<img src='"+img+"' class='m-source m-image' type='photo'>";if(""==temp&&(temp+="<a class='m-source m-image m-add'></a><input type='file' class='upload photoInput' accept='image/*' role='design'>"),temp+=img,"index"==role){var i=require("../image/image"),Picture=new i;Picture.drawImage($(img)),$(".m-index").hide(),resetEffectPage()}else $(".m-content").html(temp),Photo._init(),mEvent.listen._imageSelect()},resetEffectPage=function(){mEvent.listen._effectSelect(),mEvent.listen._init()},imageCompress=function(url,callback){var $img=$("<img>");$img.on("load",function(){var percent,imageWidth,imageHeight,square=700,medium=document.getElementById("medium");this.width>this.height?(percent=this.height/square,imageWidth=this.width/percent,imageHeight=square):(percent=this.width/square,imageWidth=square,imageHeight=this.height/percent),medium.width=imageWidth,medium.height=imageHeight;var context=medium.getContext("2d");context.clearRect(0,0,imageWidth,imageHeight);var offsetX=0,offsetY=0;context.drawImage(this,offsetX,offsetY,imageWidth,imageHeight);var data=medium.toDataURL("image/jpeg");callback(data)}),$img.attr("src",url)}});